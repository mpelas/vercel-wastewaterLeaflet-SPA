<!DOCTYPE html>
<html>
<head>
    <title>Wastewater No-Swim Zones</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; }
        #map { height: 100vh; width: 100%; }
        .info {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js"></script>
    <script>
        // Initialize map
        const map = L.map('map').setView([40.6401, 22.9444], 6);
        
        // Add base map
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap',
            maxZoom: 19
        }).addTo(map);

        // Info box
        const info = L.control({position: 'topright'});
        info.onAdd = function() {
            this._div = L.DomUtil.create('div', 'info');
            this._div.innerHTML = '<h4>Loading KML...</h4>';
            return this._div;
        };
        info.addTo(map);

        // Direct URL (no proxy needed - CORS is configured on GCS)
        const kmlUrl = 'https://storage.googleapis.com/wastewater_plants_spa/wastewater_no_swim_zones.kml';
        
        // Load KML directly
        fetch(kmlUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.text();
            })
            .then(kmlText => {
                // Parse KML
                const parser = new DOMParser();
                const kml = parser.parseFromString(kmlText, 'text/xml');
                
                // Check for XML parsing errors
                const parseError = kml.querySelector('parsererror');
                if (parseError) {
                    throw new Error('KML parsing error');
                }
                
                // Convert KML to GeoJSON using omnivore
                const kmlLayer = omnivore.kml.parse(kmlText);
                
                // Style the layer
                kmlLayer.eachLayer(layer => {
                    if (layer.feature && layer.feature.properties) {
                        const isCompliant = layer.feature.properties['Column1.compliance'] !== 'false';
                        
                        layer.setStyle({
                            fillColor: isCompliant ? '#3388ff' : '#ff0000',
                            fillOpacity: 0.5,
                            color: 'white',
                            weight: 2
                        });
                        
                        // Add popup
                        const props = layer.feature.properties;
                        layer.bindPopup(`
                            <strong>${props.name || 'Location'}</strong><br>
                            Status: ${isCompliant ? '✓ Compliant' : '⚠️ Non-Compliant'}
                        `);
                    }
                });
                
                kmlLayer.addTo(map);
                map.fitBounds(kmlLayer.getBounds());
                
                info._div.innerHTML = '<h4>Wastewater Zones</h4>Click zones for info';
            })
            .catch(error => {
                console.error('Error loading KML:', error);
                info._div.innerHTML = `<h4>Error</h4>Failed to load KML<br><small>${error.message}</small>`;
            });

        // Legend
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function() {
            const div = L.DomUtil.create('div', 'info');
            div.innerHTML = `
                <strong>Status</strong><br>
                <span style="color: #3388ff;">■</span> Compliant<br>
                <span style="color: #ff0000;">■</span> Non-Compliant
            `;
            return div;
        };
        legend.addTo(map);
    </script>
</body>
</html>